<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PropertyAgent Pro - AI Template Manager</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-info {
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-indicator {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(46, 204, 113, 0.2);
            color: #27ae60;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
        }

        .main-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .side-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(102, 126, 234, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .stat-change {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            font-weight: 600;
        }

        .stat-change.positive { color: #27ae60; }
        .stat-change.negative { color: #e74c3c; }

        .leads-section {
            margin-bottom: 2rem;
        }

        .leads-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .leads-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .leads-table th,
        .leads-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .leads-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        .leads-table tr:hover {
            background: #f8f9ff;
        }

        .badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-hot { background: #ffebee; color: #c62828; }
        .badge-warm { background: #fff3e0; color: #ef6c00; }
        .badge-cold { background: #e3f2fd; color: #1565c0; }

        .whatsapp-btn {
            background: #25d366;
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .whatsapp-btn:hover {
            background: #20ba5a;
            transform: translateY(-2px);
        }

        .whatsapp-btn.sent {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .ai-chat-section {
            margin-bottom: 2rem;
        }

        .chat-container {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 2px solid #e8f2ff;
            max-height: 300px;
            overflow-y: auto;
        }

        .chat-message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 12px;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-user {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .chat-ai {
            background: white;
            border: 1px solid #ddd;
            margin-right: auto;
        }

        .chat-input-container {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 0.8rem 1rem;
            border: 2px solid #e8f2ff;
            border-radius: 25px;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .send-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .send-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .template-preview {
            background: white;
            border: 2px solid #e8f2ff;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .template-label {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .template-updated {
            font-size: 0.75rem;
            color: #27ae60;
            font-weight: normal;
        }

        .template-content {
            background: #f8f9ff;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            line-height: 1.5;
            border-left: 4px solid #667eea;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-success:hover {
            background: #27ae60;
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .processing-indicator {
            display: none;
            text-align: center;
            padding: 1rem;
            color: #667eea;
        }

        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success { background: #27ae60; }
        .notification.error { background: #e74c3c; }
        .notification.info { background: #3498db; }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .quick-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            .quick-stats {
                grid-template-columns: 1fr;
            }
            
            .leads-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                🏠 PropertyAgent Pro
            </div>
            <div class="user-info">
                <div class="status-indicator" id="statusIndicator">⚡ System Online</div>
                <span>Sarah Lim - ERA Singapore</span>
                <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">SL</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="main-panel">
            <!-- Quick Stats -->
            <div class="quick-stats">
                <div class="stat-card">
                    <div class="stat-number" id="pendingLeads">15</div>
                    <div class="stat-label">Pending Leads</div>
                    <div class="stat-change positive">+3 today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="hotProspects">8</div>
                    <div class="stat-label">Hot Prospects</div>
                    <div class="stat-change positive">+2 today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="responseRate">67%</div>
                    <div class="stat-label">Response Rate</div>
                    <div class="stat-change positive">+5% this week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="templateScore">9.2</div>
                    <div class="stat-label">Template Score</div>
                    <div class="stat-change positive">+0.3 this week</div>
                </div>
            </div>

            <!-- AI Template Chat -->
            <div class="ai-chat-section">
                <h2 class="section-title">🤖 AI Template Assistant</h2>
                <div class="chat-container" id="chatContainer">
                    <div class="chat-message chat-ai">
                        <strong>AI Assistant:</strong> Hi Sarah! 👋 I can help you optimize your message templates. What would you like to improve today?
                    </div>
                    <div id="chatMessages"></div>
                </div>
                
                <div class="processing-indicator" id="processingIndicator">
                    <div class="spinner"></div>
                    Updating templates with AI...
                </div>
                
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="e.g., 'Make my commercial messages more urgent' or 'Add more warmth to residential templates'">
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send</button>
                </div>
            </div>

            <!-- Leads Table -->
            <div class="leads-section">
                <div class="leads-controls">
                    <h2 class="section-title">📋 Today's Leads</h2>
                    <button class="btn btn-primary" id="processBtn" onclick="processLeads()">
                        🤖 AI Process All Leads
                    </button>
                    <button class="btn btn-success" onclick="refreshLeads()">
                        🔄 Refresh
                    </button>
                </div>
                
                <table class="leads-table">
                    <thead>
                        <tr>
                            <th>Lead</th>
                            <th>Property Interest</th>
                            <th>AI Score</th>
                            <th>Generated Message Preview</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="leadsTableBody">
                        <tr>
                            <td>
                                <strong>John Tan</strong><br>
                                <small>+65 9123 4567</small>
                            </td>
                            <td>Commercial Office</td>
                            <td><span class="badge badge-hot">HOT</span></td>
                            <td>
                                <small style="color: #666;">
                                    "Hi John! 🏢 Exciting commercial opportunity for Commercial Office: Time-sensitive buyer - prioritize immediate contact. Ready to discuss? Sarah Lim +65 9123 4567"
                                </small>
                            </td>
                            <td>
                                <button class="whatsapp-btn" onclick="sendWhatsApp(this, 'John Tan', '+6591234567')">
                                    📱 Send WhatsApp
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <strong>Mary Lim</strong><br>
                                <small>+65 8765 4321</small>
                            </td>
                            <td>2BR Condo</td>
                            <td><span class="badge badge-warm">WARM</span></td>
                            <td>
                                <small style="color: #666;">
                                    "Hi Mary! 🏠 Found perfect 2BR Condo match: First-time buyer - provide guidance and market education. Viewing available? Sarah Lim +65 9123 4567"
                                </small>
                            </td>
                            <td>
                                <button class="whatsapp-btn" onclick="sendWhatsApp(this, 'Mary Lim', '+6587654321')">
                                    📱 Send WhatsApp
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="side-panel">
            <!-- File Upload -->
            <div class="upload-section">
                <h3 class="section-title">📁 Import Leads</h3>
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">📄</div>
                    <p><strong>Drop CSV/Excel here</strong></p>
                    <p>or click to browse</p>
                    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                </div>
            </div>

            <!-- Current Templates -->
            <div class="template-section">
                <h3 class="section-title">📝 Live Templates</h3>
                
                <div class="template-preview">
                    <div class="template-label">
                        Commercial Properties
                        <span class="template-updated" id="commercialUpdated">Updated 2h ago</span>
                    </div>
                    <div class="template-content" id="commercialTemplate">
                        Hi {{name}}! 🏢<br><br>
                        I have an exciting commercial opportunity that matches your {{propertyType}} search criteria.<br><br>
                        ✨ Key highlights:<br>
                        • {{insights}}<br>
                        • Prime location with excellent accessibility<br>
                        • Strong ROI potential<br><br>
                        Ready to discuss? {{agentName}} {{agentPhone}}
                    </div>
                </div>

                <div class="template-preview">
                    <div class="template-label">
                        Residential Properties
                        <span class="template-updated" id="residentialUpdated">Updated 1h ago</span>
                    </div>
                    <div class="template-content" id="residentialTemplate">
                        Hi {{name}}! 🏠<br><br>
                        Found perfect {{propertyType}} match:<br><br>
                        ✨ What makes this special:<br>
                        • {{insights}}<br>
                        • Move-in ready condition<br>
                        • Excellent location<br><br>
                        Viewing available? {{agentName}} {{agentPhone}}
                    </div>
                </div>

                <button class="btn btn-success" onclick="showTemplateHistory()" style="width: 100%; margin-bottom: 0.5rem;">
                    📊 View Template Performance
                </button>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h3 class="section-title">⚡ Quick Actions</h3>
                <button class="btn btn-primary" onclick="optimizeTemplates()" style="width: 100%; margin-bottom: 0.5rem;">
                    🎯 Auto-Optimize All Templates
                </button>
                <button class="btn btn-primary" onclick="analyzePerformance()" style="width: 100%;">
                    📈 Analyze Response Rates
                </button>
            </div>
        </div>
    </div>

    <!-- Notification System -->
    <div id="notification" class="notification"></div>

    <script>
        // Configuration - LIVE n8n URLs
        const CONFIG = {
            N8N_BASE_URL: 'https://n8n.opsmith.biz/webhook',
            GITHUB_REPO: 'mqopsmith/PropertyAgent-Pro',
            AGENT_ID: 'sarah-lim-001',
            TEST_MODE: false
        };

        // API endpoints
        const ENDPOINTS = {
            PROCESS_LEADS: `${CONFIG.N8N_BASE_URL}/property-agent-main`,
            UPDATE_TEMPLATES: `${CONFIG.N8N_BASE_URL}/update-templates`,
        };

        // Global state
        let templates = {
            commercial: {
                content: "Hi {{name}}! 🏢\n\nI have an exciting commercial opportunity that matches your {{propertyType}} search criteria.\n\n✨ Key highlights:\n• {{insights}}\n• Prime location with excellent accessibility\n• Strong ROI potential\n\nReady to discuss? {{agentName}} {{agentPhone}}",
                lastUpdated: new Date(Date.now() - 2 * 60 * 60 * 1000) // 2 hours ago
            },
            residential: {
                content: "Hi {{name}}! 🏠\n\nFound perfect {{propertyType}} match:\n\n✨ What makes this special:\n• {{insights}}\n• Move-in ready condition\n• Excellent location\n\nViewing available? {{agentName}} {{agentPhone}}",
                lastUpdated: new Date(Date.now() - 1 * 60 * 60 * 1000) // 1 hour ago
            }
        };

        let isProcessing = false;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            checkSystemStatus();
        });

        function initializeApp() {
            addChatMessage('ai', 'Welcome back, Sarah! 👋 I can help you optimize templates, analyze leads, or answer questions about your outreach strategy.');
            updateTemplateTimestamps();
        }

        function setupEventListeners() {
            // Enter key to send messages
            document.getElementById('chatInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // File upload handling
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);

            // Drag and drop for file upload
            const uploadArea = document.querySelector('.upload-area');
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleFileDrop);
        }

        // AI Template Optimization
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const message = input.value.trim();
            
            if (!message || isProcessing) return;

            // Disable input
            input.disabled = true;
            sendBtn.disabled = true;
            isProcessing = true;

            // Add user message to chat
            addChatMessage('user', message);
            input.value = '';

            // Show processing indicator
            showProcessingIndicator(true);

            try {
                await updateTemplateViaAPI(message);
            } catch (error) {
                console.error('Error updating template:', error);
                addChatMessage('ai', '❌ Sorry, there was an issue updating the templates. Please check your connection and try again.');
                showNotification('Template update failed: ' + error.message, 'error');
            } finally {
                // Re-enable input
                input.disabled = false;
                sendBtn.disabled = false;
                isProcessing = false;
                showProcessingIndicator(false);
            }
        }

        async function updateTemplateViaAPI(userRequest) {
            const response = await fetch(ENDPOINTS.UPDATE_TEMPLATES, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'update_template',
                    userRequest: userRequest,
                    currentTemplate: templates.commercial.content,
                    propertyType: 'commercial',
                    agentId: CONFIG.AGENT_ID
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            
            if (result.success) {
                // Update template display
                updateTemplateDisplay('commercial', result.newTemplate);
                addChatMessage('ai', `✅ Templates updated! I've made your messages ${userRequest.toLowerCase()}. The changes are already live in GitHub and ready for your next outreach!`);
                showNotification('Template updated successfully', 'success');
                
                // Refresh leads preview
                refreshLeadPreviews();
            } else {
                throw new Error(result.message || 'Template update failed');
            }
        }

        // Lead Processing
        async function processLeads() {
            const btn = document.getElementById('processBtn');
            if (isProcessing) return;

            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="spinner"></div> Processing...';
            btn.disabled = true;
            isProcessing = true;

            try {
                await processLeadsViaAPI();
            } catch (error) {
                console.error('Error processing leads:', error);
                addChatMessage('ai', '❌ Error processing leads. Please check your connection and try again.');
                showNotification('Lead processing failed: ' + error.message, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                isProcessing = false;
            }
        }

        async function processLeadsViaAPI() {
            const response = await fetch(ENDPOINTS.PROCESS_LEADS, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'process_leads',
                    agentId: CONFIG.AGENT_ID
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            
            if (result.success) {
                updateLeadsTable(result.leads);
                addChatMessage('ai', `✅ Processed ${result.processed} leads! All WhatsApp messages are ready to send with personalized AI insights.`);
                showNotification(`${result.processed} leads processed successfully`, 'success');
                updateStats({ processed: result.processed });
            } else {
                throw new Error(result.message || 'Lead processing failed');
            }
        }

        // WhatsApp Integration
        function sendWhatsApp(button, leadName, phoneNumber) {
            if (button.classList.contains('sent')) return;

            // Create WhatsApp URL (in real implementation, this would use the generated URL)
            const message = `Hi ${leadName}! 🏠 I have an exciting property opportunity that matches your criteria. Would you like to know more?`;
            const whatsappUrl = `https://wa.me/${phoneNumber.replace(/[^\d]/g, '')}?text=${encodeURIComponent(message)}`;
            
            // Open WhatsApp
            window.open(whatsappUrl, '_blank');
            
            // Update button state
            button.classList.add('sent');
            button.innerHTML = '✅ Sent';
            button.onclick = null;
            
            // Update stats
            updateStats({ sent: 1 });
            
            addChatMessage('ai', `📱 WhatsApp message sent to ${leadName}! The message used your latest AI-optimized template.`);
            showNotification(`Message sent to ${leadName}`, 'success');
        }

        // UI Helper Functions
        function addChatMessage(sender, message) {
            const chatContainer = document.getElementById('chatContainer');
            const messagesDiv = document.getElementById('chatMessages') || chatContainer;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message chat-${sender}`;
            
            if (sender === 'user') {
                messageDiv.innerHTML = `<strong>You:</strong> ${message}`;
            } else {
                messageDiv.innerHTML = `<strong>AI Assistant:</strong> ${message}`;
            }
            
            messagesDiv.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function updateTemplateDisplay(templateType, newTemplate) {
            const templateElement = document.getElementById(`${templateType}Template`);
            const timestampElement = document.getElementById(`${templateType}Updated`);
            
            if (templateElement) {
                templateElement.innerHTML = newTemplate.replace(/\n/g, '<br>');
                templates[templateType].content = newTemplate;
                templates[templateType].lastUpdated = new Date();
            }
            
            if (timestampElement) {
                timestampElement.textContent = 'Just updated';
                timestampElement.style.color = '#27ae60';
                
                // Reset to normal after 5 seconds
                setTimeout(() => {
                    timestampElement.style.color = '';
                    updateTemplateTimestamps();
                }, 5000);
            }
        }

        function updateTemplateTimestamps() {
            const commercialElement = document.getElementById('commercialUpdated');
            const residentialElement = document.getElementById('residentialUpdated');
            
            if (commercialElement) {
                commercialElement.textContent = getTimeAgo(templates.commercial.lastUpdated);
            }
            
            if (residentialElement) {
                residentialElement.textContent = getTimeAgo(templates.residential.lastUpdated);
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMins = Math.floor(diffMs / (1000 * 60));
            
            if (diffHours > 0) {
                return `Updated ${diffHours}h ago`;
            } else if (diffMins > 0) {
                return `Updated ${diffMins}m ago`;
            } else {
                return 'Just updated';
            }
        }

        function showProcessingIndicator(show) {
            const indicator = document.getElementById('processingIndicator');
            indicator.style.display = show ? 'block' : 'none';
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function updateStats(changes) {
            if (changes.processed) {
                const pendingElement = document.getElementById('pendingLeads');
                const currentPending = parseInt(pendingElement.textContent);
                pendingElement.textContent = Math.max(0, currentPending - changes.processed);
            }
            
            if (changes.sent) {
                const hotElement = document.getElementById('hotProspects');
                const responseElement = document.getElementById('responseRate');
                
                // Increase response rate slightly
                const currentRate = parseInt(responseElement.textContent);
                responseElement.textContent = `${Math.min(100, currentRate + 1)}%`;
            }
        }

        function updateLeadsTable(leads) {
            const tableBody = document.getElementById('leadsTableBody');
            // Update the table with processed leads
            console.log('Updating leads table with:', leads);
        }

        function refreshLeadPreviews() {
            // Update message previews in the table with new templates
            console.log('Refreshing lead previews with updated templates');
        }

        function refreshLeads() {
            showNotification('Refreshing leads...', 'info');
            // Fetch fresh leads from Google Sheets via n8n
            setTimeout(() => {
                showNotification('Leads refreshed successfully', 'success');
            }, 1500);
        }

        function checkSystemStatus() {
            const statusIndicator = document.getElementById('statusIndicator');
            
            // Test n8n connectivity
            fetch(ENDPOINTS.PROCESS_LEADS, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: 'health_check'})
            })
            .then(response => {
                if (response.ok) {
                    statusIndicator.innerHTML = '⚡ System Online';
                    statusIndicator.style.background = 'rgba(46, 204, 113, 0.2)';
                    statusIndicator.style.color = '#27ae60';
                } else {
                    throw new Error('n8n unreachable');
                }
            })
            .catch(() => {
                statusIndicator.innerHTML = '⚠️ System Offline';
                statusIndicator.style.background = 'rgba(231, 76, 60, 0.2)';
                statusIndicator.style.color = '#e74c3c';
            });
        }

        // File Upload Functions
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) processUploadedFile(file);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function handleFileDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processUploadedFile(files[0]);
            }
        }

        function processUploadedFile(file) {
            const leadCount = Math.floor(Math.random() * 20) + 5;
            addChatMessage('ai', `📁 Processing ${file.name}... Found ${leadCount} new leads! They'll appear in your leads table shortly.`);
            
            // Simulate file processing
            setTimeout(() => {
                addChatMessage('ai', '✅ Leads imported successfully! AI analysis complete - ready for WhatsApp outreach.');
                updateStats({ processed: leadCount });
                showNotification(`${leadCount} leads imported successfully`, 'success');
            }, 2000);
        }

        // Quick Action Functions
        function optimizeTemplates() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="spinner"></div> Optimizing...';
            btn.disabled = true;

            setTimeout(() => {
                addChatMessage('ai', '🎯 Auto-optimization complete! I analyzed your response rates and updated templates for better engagement. Your commercial template response rate should improve by ~15%.');
                btn.innerHTML = originalText;
                btn.disabled = false;
                showNotification('Templates auto-optimized', 'success');
            }, 3000);
        }

        function analyzePerformance() {
            addChatMessage('ai', '📈 Response Analysis:\n• Hot leads: 89% response rate\n• Warm leads: 45% response rate\n• Best performing template: Commercial (Updated recently)\n• Suggestion: Add urgency to residential templates for better conversion');
        }

        function showTemplateHistory() {
            addChatMessage('ai', '📊 Template Performance:\n• Commercial: 73% response rate (+12% this week)\n• Residential: 68% response rate (+8% this week)\n• Best time to send: 10-11 AM, 3-4 PM\n• Top performing phrase: "Limited time opportunity"');
        }

        // Update timestamps periodically
        setInterval(updateTemplateTimestamps, 60000); // Every minute
    </script>
</body>
</html>